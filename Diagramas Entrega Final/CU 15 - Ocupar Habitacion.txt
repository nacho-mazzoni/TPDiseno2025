@startuml
title
  Diagrama_Secuencia_CU15
end title

actor Conserje
participant UI_OcuparHabitacion
participant GestorHabitacion
participant GestorReserva
participant GestorDetalleEstadia
participant ReservaDAO
participant HabitacionDAO
participant GestorEstadia
participant EstadiaDAO
participant DetalleEstadiaDAO

Conserje -> UI_OcuparHabitacion: Ocupar Habitaciones
activate UI_OcuparHabitacion

UI_OcuparHabitacion -> Conserje: Navegar a CU05 Mostrar Estado Habitaciones
Conserje -> UI_OcuparHabitacion: Seleccionar Rango de Fechas

opt no hay habitaciones disponibles
UI_OcuparHabitacion -> Conserje: mostrarMensaje(no hay habitaciones disponibles)
end

loop mientras el actor no presione siguiente
  Conserje -> UI_OcuparHabitacion: seleccionHabitacion(habitacion, fechaInicio, fechaFin)
  UI_OcuparHabitacion -> UI_OcuparHabitacion: verificar disponibilidad
  alt habitacion que no esta ni disponible ni reservada
    Conserje -> UI_OcuparHabitacion: OcuparHabitacion(habitacion,fechaInicio,fechaFin)
  else habitacion disponible o reservada pero con algun dia de la estadia con el estado distinto a "reservada"
    UI_OcuparHabitacion -> Conserje: mostrarMensaje("La habitacion estará ocupada en alguno de los días que se desea ocupar")
  else habitacion disponible o reservada pero con algun dia de la estadia con el estado "reservada"
    UI_OcuparHabitacion -> Conserje: mostrarMensaje("La habitacion esta ocupada, ¿Quiere ocuparla igual?")
    alt usuario presiona "OCUPAR IGUAL"
      Conserje -> UI_OcuparHabitacion: Ocupar igual
      deactivate GestorReserva
    else usuario presiona "VOLVER"
      Conserje -> UI_OcuparHabitacion: Volver
      end
  end
end

UI_OcuparHabitacion -> GestorHabitacion: pintarHabitacionesComoOcupadas(ListaHabitaciones)
activate GestorHabitacion
GestorHabitacion -> UI_OcuparHabitacion: retornar()
deactivate GestorHabitacion
UI_OcuparHabitacion -> Conserje: MostrarCartel("PRESIONE CUALQUIER TECLA Y CONTINUA")
deactivate UI_OcuparHabitacion
Conserje -> UI_OcuparHabitacion: Presiona cualquier tecla
activate UI_OcuparHabitacion

loop mientras se sigan cargando huespedes
  UI_OcuparHabitacion -> Conserje: mostrarPantallaSimilarBuscarHuesped
  deactivate UI_OcuparHabitacion
  loop mientras el actor no presione "Buscar"
    Conserje -> UI_OcuparHabitacion: completar campos
    activate UI_OcuparHabitacion
    deactivate UI_OcuparHabitacion
  end
  Conserje -> UI_OcuparHabitacion: Buscar
  activate UI_OcuparHabitacion
  alt campos estan completos
    UI_OcuparHabitacion -> GestorHabitacion: getListaHuespedes(apellidoDTO, nombresDTO, tipodocDTO, nrodocDTO)
    activate GestorHabitacion
    GestorHabitacion -> HabitacionDAO: getListaHuespedes(apellidoDTO, nombresDTO, tipodocDTO, nrodocDTO)
    activate HabitacionDAO
  else no completa ningun campo
    UI_OcuparHabitacion -> GestorHabitacion: getListaHuespedes()
    GestorHabitacion -> HabitacionDAO: getListaHuespedes()
  end
HabitacionDAO -> GestorHabitacion: return(ListaHuespedes)
deactivate HabitacionDAO
GestorHabitacion -> UI_OcuparHabitacion: return(ListaHuespedes)
deactivate GestorHabitacion
UI_OcuparHabitacion -> Conserje: mostrarGrilla
deactivate UI_OcuparHabitacion
loop mientras no se presione "ACEPTAR" habiendo seleccionado al menos un huesped
    Conserje -> UI_OcuparHabitacion: seleccionarHuespedes(ListaHuespedes)
    activate UI_OcuparHabitacion
    Conserje -> UI_OcuparHabitacion: ACEPTAR
    opt usuario presiona "ACEPTAR" sin especificar algun Huesped
      UI_OcuparHabitacion -> Conserje: mostrarGrilla
    end
end

opt la habitacion seleccionada no estaba reservada en el rango de fechas
    UI_OcuparHabitacion -> GestorReserva: crearReserva(habitacion, huespedTitular)
    deactivate UI_OcuparHabitacion
    activate GestorReserva
    create ReservaInst
    GestorReserva -> ReservaInst: <<create>>
    activate ReservaInst
    GestorReserva -> ReservaInst: setHabitacines(ListaHabitaciones)
    GestorReserva -> ReservaInst: setHuespedTitular(Huesped)
    GestorReserva -> ReservaInst: setFechaInicioyFin(fechaInicioDTO, fechaFinDTO)
    deactivate ReservaInst
    GestorReserva -> UI_OcuparHabitacion: return(reservaInst)
    deactivate GestorReserva
    activate UI_OcuparHabitacion
end
opt la habitacion seleccionada estaba reservada en el rango de fechas
    activate UI_OcuparHabitacion 
    UI_OcuparHabitacion -> GestorReserva: buscarReserva(ListaHabitaciones, huespedTitularDTO, fechaInicioDTO, fechaFinDTO) //huespedTitular es el primer huesped que se asigna a la estadia
    activate GestorReserva
    deactivate UI_OcuparHabitacion
    alt el huesped seleccionado no es el titular de la reserva
      loop huesped seleccinado distinto a huesped titular
      UI_OcuparHabitacion -> Conserje: "El huesped seleccionado no es el titular de la reserva"
      activate UI_OcuparHabitacion
      UI_OcuparHabitacion -> Conserje: mostrarGrilla
      deactivate UI_OcuparHabitacion
      end
    end
    GestorReserva -> UI_OcuparHabitacion: returnReserva(reservaInst)
    deactivate GestorReserva
    activate UI_OcuparHabitacion
end

UI_OcuparHabitacion -> GestorEstadia: ocuparHabitacion(habitacion, ListaHuespedes)
deactivate UI_OcuparHabitacion
activate GestorEstadia
create EstadiaInst
GestorEstadia --> EstadiaInst: <<create>>
activate EstadiaInst
GestorEstadia -> EstadiaInst: setReserva(reservaInst)
GestorEstadia -> EstadiaInst : setHoraCheckIn(hora_CheckIn)
GestorEstadia -> EstadiaInst : setPrecio(Precio)
deactivate EstadiaInst
GestorEstadia -> EstadiaDAO : registrarEstadia(EstadiaInst)
activate EstadiaDAO
EstadiaDAO -> GestorEstadia : return()
deactivate EstadiaDAO

GestorEstadia -> GestorDetalleEstadia: crearDetalleEstadia(EstadiaInst, ListaHuespedes)
deactivate GestorEstadia
activate GestorDetalleEstadia
loop ListaHuespedes
  create DetalleInst
  GestorDetalleEstadia -> DetalleInst <<create>>
  activate DetalleInst
  GestorDetalleEstadia -> DetalleInst: setEstadia(EstadiaInst)
  GestorDetalleEstadia -> DetalleInst: setHuesped(ListaHuespedes[i]) // uno por posicion
  deactivate DetalleInst
end
GestorDetalleEstadia -> DetalleEstadiaDAO: registrarDetalleEstadia(DetalleInst)
activate DetalleEstadiaDAO
DetalleEstadiaDAO -> GestorDetalleEstadia: return()
deactivate DetalleEstadiaDAO

GestorDetalleEstadia -> UI_OcuparHabitacion: return
deactivate GestorDetalleEstadia
activate UI_OcuparHabitacion

UI_OcuparHabitacion -> Conserje: mostrarMensaje("Habitacion/es ocupada/s")

UI_OcuparHabitacion -> Conserje: mostrarBotones(“CARGAR OTRA HABITACIÓN”, “SALIR”)
deactivate UI_OcuparHabitacion

opt usuario presiona "CARGAR OTRA HABITACION"
  Conserje -> UI_OcuparHabitacion: CARGAR OTRA HABITACION
  activate UI_OcuparHabitacion
  UI_OcuparHabitacion -> Conserje: volver a la pantalla de estados de habitaciones
  deactivate UI_OcuparHabitacion
end
opt usuario presiona "SALIR"
  Conserje -> UI_OcuparHabitacion: SALIR
  activate UI_OcuparHabitacion
  UI_OcuparHabitacion -> Conserje: volver al menu
end

deactivate UI_OcuparHabitacion
@enduml
